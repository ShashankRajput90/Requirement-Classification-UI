<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Classification Tool</title>

  <!-- Bootstrap & fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- App CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <div class="app-shell container-fluid">
    <div class="row gx-0">

      <!-- Sidebar -->
      <aside class="col-md-3 sidebar p-4">
        <div class="sidebar-top text-center mb-4">
          <h4 class="brand-title">FR / NFR</h4>
          <div class="muted">Classification Tool</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Choose Model</label>
          <select id="modelSelect" class="form-select">
            {% for model in models %}
              <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>{{ model }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Prompt Strategy</label>
          <select id="promptSelect" class="form-select">
            {% for prompt in prompts %}
              <option value="{{ prompt }}" {% if prompt == selected_prompt %}selected{% endif %}>{{ prompt }}</option>
            {% endfor %}
          </select>
        </div>

        <hr>

        <nav class="nav flex-column nav-pills sidebar-nav" id="navigationTabs" role="tablist">
          <button class="nav-link active" id="single-tab" data-bs-toggle="pill" data-bs-target="#single" type="button">Single Classification</button>
          <button class="nav-link" id="batch-tab" data-bs-toggle="pill" data-bs-target="#batch" type="button">Batch Processing</button>
          <button class="nav-link" id="comparison-tab" data-bs-toggle="pill" data-bs-target="#comparison" type="button">Model Comparison</button>
          <button class="nav-link" id="analytics-tab" data-bs-toggle="pill" data-bs-target="#analytics" type="button">Analytics Dashboard</button>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="col-md-9 content-area p-4">
        <header class="mb-4 text-center">
          <h1 class="main-header">FR / NFR Classification Tool</h1>
          <p class="lead muted">Evaluate models · Inspect predictions · See analytics</p>
        </header>

        <div class="tab-content" id="mainContent">
          <!-- Single -->
          <section class="tab-pane fade show active" id="single">
            <div class="row">
              <div class="col-lg-8">
                <label class="form-label"><strong>Input user story</strong></label>
                <textarea id="userStory" class="form-control mb-3" rows="5" placeholder="As a user, I want the system to respond within 2 seconds..."></textarea>
                <div class="d-flex gap-2">
                  <button id="classifyBtn" class="btn btn-primary" onclick="classifyStory()">
                    <span class="spinner-border spinner-border-sm me-2 loading" style="display:none;"></span>
                    Classify
                  </button>
                  <button class="btn btn-outline-secondary" onclick="loadExample('fr')">Load FR Example</button>
                  <button class="btn btn-outline-secondary" onclick="loadExample('nfr')">Load NFR Example</button>
                </div>

                <div id="singleResult" class="mt-3"></div>
              </div>

              <aside class="col-lg-4">
                <div id="recentClassifications" class="card p-3">
                  <h6 class="mb-2">Recent</h6>
                  <div id="recentBrief" class="text-muted small">Run a classification to populate history.</div>
                </div>
              </aside>
            </div>
          </section>

          <!-- Batch (kept minimal here) -->
          <section class="tab-pane fade" id="batch">
            <div class="row">
              <div class="col-md-6">
                <div class="card p-3">
                  <h6>Batch CSV</h6>
                  <form id="batchForm" enctype="multipart/form-data">
                    <input id="csvFile" type="file" accept=".csv" class="form-control mb-2" />
                    <div id="sliderSection" style="display:none;">
                      <label>Stories to process: <span id="storiesCount">25</span></label>
                      <input id="maxStories" type="range" min="1" max="500" value="25" class="form-range" />
                    </div>
                    <button class="btn btn-primary mt-2" type="submit">Process batch</button>
                  </form>
                </div>
              </div>

              <div class="col-md-6">
                <div id="batchProgress" style="display:none;"></div>
                <div id="batchResults"></div>
              </div>
            </div>
          </section>

          <!-- Comparison -->
          <section class="tab-pane fade" id="comparison">
            <div class="card p-3 mb-3">
              <div class="row">
                <div class="col-md-6">
                  <h6>Select Models</h6>
                  <div id="compare-models" class="d-flex flex-column gap-1">
                    {% for model in models %}
                      <label class="form-check">
                        <input class="form-check-input" type="checkbox" name="compare_model" value="{{ model }}">
                        <span class="form-check-label">{{ model }}</span>
                      </label>
                    {% endfor %}
                  </div>
                </div>
                <div class="col-md-6">
                  <h6>Select Prompts</h6>
                  <div id="compare-prompts" class="d-flex flex-column gap-1">
                    {% for prompt in prompts %}
                      <label class="form-check">
                        <input class="form-check-input" type="checkbox" name="compare_prompt" value="{{ prompt }}">
                        <span class="form-check-label">{{ prompt }}</span>
                      </label>
                    {% endfor %}
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <button class="btn btn-primary" onclick="compareModels()">
                  <span class="spinner-border spinner-border-sm me-2" id="compareLoading" style="display:none;"></span>
                  Run Comparison
                </button>
              </div>
            </div>
            <div id="comparisonResults"></div>
          </section>

          <!-- Analytics -->
          <section class="tab-pane fade" id="analytics">
            <div class="mb-3 row" id="analyticsMetrics"></div>

            <div class="row mb-4">
              <div class="col-md-6">
                <div id="distributionChart" class="chart-container card p-3"></div>
              </div>
              <div class="col-md-6">
                <div id="modelChart" class="chart-container card p-3"></div>
              </div>
            </div>

            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Model Summary</h5>
                <div>
                  <button class="btn btn-sm btn-success me-2" onclick="downloadHistory()"><i class="fas fa-download"></i> Download CSV</button>
                  <button class="btn btn-sm btn-danger" onclick="clearHistory()"><i class="fas fa-trash"></i> Clear History</button>
                </div>
              </div>
              <div class="card-body">
                <div id="recentActivity"></div>
              </div>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- Bootstrap + app JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script>
    // Initialize after main.js is loaded to avoid ReferenceError
    initializeApp("{{ selected_model }}","{{ selected_prompt }}");
  </script>
</body>
</html>
